#!/bin/zsh
set -eu
source src/common.sh

aconf-compile

# Unknown packages (installed but not listed)

UNKNOWN_PACKAGES=($(comm -13 <(echo "$PACKAGES") <(echo "$INSTALLED_PACKAGES")))

if [[ ${#UNKNOWN_PACKAGES} != 0 ]]
then
	echo "Found ${#UNKNOWN_PACKAGES} unknown packages. Registering..."
	echo "\n\n# $(date) - Unknown packages\n\n" >> $CONFIG_SAVE_TARGET
	for PACKAGE in $UNKNOWN_PACKAGES
	do
		echo ">> \"\$OUTPUT_DIR\"/packages.txt echo '$PACKAGE' #$(pacman -Qi $PACKAGE | grep '^Description' | cut -d ':' -f 2)" >> $CONFIG_SAVE_TARGET
	done
fi

# Missing packages (listed but not installed on current system)

MISSING_PACKAGES=($(comm -23 <(echo "$PACKAGES") <(echo "$INSTALLED_PACKAGES")))

if [[ ${#MISSING_PACKAGES} != 0 ]]
then
	echo "Found ${#MISSING_PACKAGES} missing packages. Un-registering."
	echo "\n\n# $(date) - Missing packages\n\n" >> $CONFIG_SAVE_TARGET
	for PACKAGE in $MISSING_PACKAGES
	do
		echo "sed -i '/^$PACKAGE\$/d' \"\$OUTPUT_DIR\"/packages.txt" >> $CONFIG_SAVE_TARGET
	done
fi

echo "Done."
